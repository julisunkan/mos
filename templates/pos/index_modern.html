{% extends "base.html" %}

{% block title %}Modern POS - {{ store.name }}{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #8b5cf6;
        --primary-dark: #7c3aed;
        --secondary: #a855f7;
        --accent: #c084fc;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --dark: #0f0f0f;
        --darker: #0a0a0a;
        --light: #f8fafc;
        --gray-900: #111827;
        --gray-800: #1f2937;
        --gray-700: #374151;
        --glass: rgba(0, 0, 0, 0.6);
        --glass-border: rgba(139, 92, 246, 0.3);
        --glass-light: rgba(139, 92, 246, 0.1);
        --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(139, 92, 246, 0.1);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        --gradient-success: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        --gradient-bg: linear-gradient(135deg, #0a0a0a 0%, #1a0f2e 50%, #0f0f0f 100%);
    }
    
    * {
        box-sizing: border-box;
    }
    
    body {
        background: var(--gradient-bg);
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        overflow-x: hidden;
    }
    
    .pos-wrapper {
        min-height: 100vh;
        padding: 20px;
        position: relative;
    }
    
    /* Animated Background */
    .bg-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.1;
    }
    
    .floating-shapes {
        position: absolute;
        width: 100%;
        height: 100%;
    }
    
    .shape {
        position: absolute;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 50%;
        animation: float 20s infinite linear;
    }
    
    .shape:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-delay: 0s; }
    .shape:nth-child(2) { width: 120px; height: 120px; left: 20%; animation-delay: 2s; }
    .shape:nth-child(3) { width: 60px; height: 60px; left: 70%; animation-delay: 4s; }
    .shape:nth-child(4) { width: 100px; height: 100px; left: 80%; animation-delay: 6s; }
    
    @keyframes float {
        0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }
    
    /* Header with Glassmorphism */
    .pos-header {
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        color: white;
    }
    
    .pos-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--gradient-primary);
        opacity: 0.8;
        z-index: -1;
    }
    
    .pos-header::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 50%;
        animation: pulse 4s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.1; }
        50% { transform: scale(1.2); opacity: 0.2; }
    }
    
    .header-content {
        position: relative;
        z-index: 1;
    }
    
    .store-brand {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 16px;
    }
    
    .store-avatar {
        width: 72px;
        height: 72px;
        background: rgba(139, 92, 246, 0.2);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(139, 92, 246, 0.4);
    }
    
    .store-info h1 {
        font-size: 36px;
        font-weight: 800;
        margin: 0;
        background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .store-meta {
        display: flex;
        gap: 24px;
        margin-top: 16px;
        opacity: 0.9;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }
    
    .header-actions {
        position: absolute;
        top: 32px;
        right: 32px;
        z-index: 2;
    }
    
    /* Main Layout - Creative Grid */
    .pos-main {
        display: grid;
        grid-template-areas: 
            "search search cart-header"
            "products products cart-content"
            "products products cart-summary";
        grid-template-columns: 1fr 1fr 400px;
        grid-template-rows: auto 1fr auto;
        gap: 24px;
        height: calc(100vh - 200px);
        min-height: 700px;
    }
    
    /* Search Section */
    .search-section {
        grid-area: search;
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
    }
    
    .search-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
        z-index: -1;
    }
    
    .search-container {
        position: relative;
        max-width: 600px;
    }
    
    .search-input {
        width: 100%;
        padding: 20px 24px 20px 60px;
        border: 2px solid rgba(139, 92, 246, 0.3);
        border-radius: 50px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 18px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .search-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    .search-input:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.6);
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
    }
    
    .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(139, 92, 246, 0.8);
        font-size: 20px;
    }
    
    /* Products Section */
    .products-section {
        grid-area: products;
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        overflow: hidden;
        position: relative;
    }
    
    .products-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(139, 92, 246, 0.05);
        z-index: -1;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        height: 100%;
        overflow-y: auto;
        padding-right: 8px;
    }
    
    /* Custom scrollbar */
    .products-grid::-webkit-scrollbar {
        width: 8px;
    }
    
    .products-grid::-webkit-scrollbar-track {
        background: rgba(139, 92, 246, 0.1);
        border-radius: 4px;
    }
    
    .products-grid::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.4);
        border-radius: 4px;
    }
    
    .products-grid::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 92, 246, 0.6);
    }
    
    .product-card {
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: fit-content;
    }
    
    .product-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-primary);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-xl);
        border-color: rgba(139, 92, 246, 0.5);
        background: rgba(0, 0, 0, 0.8);
    }
    
    .product-card:hover::before {
        transform: scaleX(1);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
    }
    
    .product-name {
        font-weight: 700;
        color: white;
        font-size: 16px;
        margin: 0;
        line-height: 1.3;
        flex: 1;
        margin-right: 12px;
    }
    
    .product-sku {
        background: rgba(139, 92, 246, 0.2);
        color: rgba(139, 92, 246, 0.9);
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .product-price {
        font-size: 22px;
        font-weight: 800;
        color: #4ade80;
        margin-bottom: 12px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .product-stock {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }
    
    .stock-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        backdrop-filter: blur(10px);
    }
    
    .stock-high { 
        background: rgba(16, 185, 129, 0.2); 
        color: #6ee7b7; 
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .stock-medium { 
        background: rgba(245, 158, 11, 0.2); 
        color: #fbbf24; 
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .stock-low { 
        background: rgba(239, 68, 68, 0.2); 
        color: #fca5a5; 
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .btn-add {
        width: 100%;
        padding: 12px 16px;
        border: none;
        border-radius: 12px;
        background: var(--gradient-success);
        color: white;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
    }
    
    .btn-add::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .btn-add:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }
    
    .btn-add:hover:not(:disabled)::before {
        left: 100%;
    }
    
    .btn-add:disabled {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.5);
        cursor: not-allowed;
    }
    
    /* Cart Section */
    .cart-header {
        grid-area: cart-header;
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
    }
    
    .cart-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
        opacity: 0.9;
        z-index: -1;
    }
    
    .cart-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
    }
    
    .cart-title h3 {
        font-size: 24px;
        font-weight: 800;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .cart-count {
        background: var(--gradient-primary);
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
    }
    
    .cart-content {
        grid-area: cart-content;
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        overflow-y: auto;
        position: relative;
    }
    
    .cart-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: -1;
    }
    
    .customer-section {
        margin-bottom: 24px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: white;
        font-size: 14px;
    }
    
    .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-select:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.6);
        background: rgba(0, 0, 0, 0.8);
    }
    
    .cart-items {
        min-height: 200px;
    }
    
    .empty-cart {
        text-align: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .empty-cart i {
        font-size: 48px;
        color: rgba(139, 92, 246, 0.5);
        margin-bottom: 16px;
    }
    
    .cart-item {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .cart-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--gradient-primary);
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }
    
    .cart-item:hover {
        border-color: rgba(139, 92, 246, 0.4);
        background: rgba(0, 0, 0, 0.6);
        transform: translateX(4px);
    }
    
    .cart-item:hover::before {
        transform: scaleY(1);
    }
    
    .cart-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }
    
    .cart-item-name {
        font-weight: 600;
        color: white;
        flex: 1;
        margin-right: 12px;
    }
    
    .cart-item-remove {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
    }
    
    .cart-item-remove:hover {
        background: rgba(239, 68, 68, 0.3);
        transform: scale(1.05);
    }
    
    .cart-item-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 8px;
        padding: 4px;
    }
    
    .btn-qty {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        background: rgba(139, 92, 246, 0.2);
        color: white;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-qty:hover {
        background: var(--gradient-primary);
        transform: scale(1.1);
    }
    
    .quantity-input {
        width: 50px;
        padding: 8px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: white;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
    }
    
    .cart-item-price {
        text-align: right;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .cart-item-total {
        font-weight: 700;
        font-size: 16px;
        color: #4ade80;
    }
    
    .cart-summary {
        grid-area: cart-summary;
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
    }
    
    .cart-summary::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(0, 0, 0, 0.4) 100%);
        z-index: -1;
    }
    
    .summary-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 16px;
        color: white;
        font-weight: 500;
    }
    
    .summary-total {
        display: flex;
        justify-content: space-between;
        font-size: 24px;
        font-weight: 800;
        color: white;
        margin: 20px 0;
        padding-top: 16px;
        border-top: 2px solid rgba(139, 92, 246, 0.3);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .payment-section {
        margin-top: 20px;
    }
    
    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.6);
        background: rgba(0, 0, 0, 0.8);
    }
    
    .cash-details {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
        backdrop-filter: blur(10px);
    }
    
    .change-amount {
        text-align: right;
        font-weight: 700;
        color: #4ade80;
        margin-top: 8px;
        font-size: 18px;
    }
    
    .btn-checkout {
        width: 100%;
        padding: 18px 24px;
        border: none;
        border-radius: 16px;
        background: var(--gradient-success);
        color: white;
        font-weight: 800;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-top: 24px;
        position: relative;
        overflow: hidden;
    }
    
    .btn-checkout::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s ease;
    }
    
    .btn-checkout:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl);
    }
    
    .btn-checkout:hover::before {
        left: 100%;
    }
    
    .btn-close-register {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .btn-close-register:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.6);
        transform: translateY(-2px);
    }
    
    /* Loading and Modal Styles */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .loading-spinner {
        text-align: center;
        color: white;
    }
    
    .loading-spinner .spinner-border {
        width: 4rem;
        height: 4rem;
        border-width: 0.5rem;
    }
    
    /* Responsive Design */
    @media (max-width: 1400px) {
        .pos-main {
            grid-template-columns: 1fr 1fr 380px;
        }
    }
    
    @media (max-width: 1200px) {
        .pos-main {
            grid-template-areas: 
                "search search search"
                "products products cart-header"
                "products products cart-content"
                "products products cart-summary";
            grid-template-columns: 1fr 1fr 360px;
        }
        
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }
    
    @media (max-width: 992px) {
        .pos-main {
            grid-template-areas: 
                "search"
                "products"
                "cart-header"
                "cart-content" 
                "cart-summary";
            grid-template-columns: 1fr;
            height: auto;
            gap: 16px;
        }
        
        .products-section {
            min-height: 400px;
        }
        
        .cart-content {
            min-height: 300px;
        }
    }
    
    @media (max-width: 768px) {
        .pos-wrapper {
            padding: 16px;
        }
        
        .pos-header {
            padding: 24px;
        }
        
        .store-info h1 {
            font-size: 28px;
        }
        
        .store-meta {
            flex-direction: column;
            gap: 8px;
        }
        
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .header-actions {
            position: relative;
            top: auto;
            right: auto;
            margin-top: 16px;
        }
    }
    
    @media (max-width: 576px) {
        .store-brand {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }
        
        .products-grid {
            grid-template-columns: 1fr;
        }
        
        .search-input {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .store-avatar {
            width: 56px;
            height: 56px;
            font-size: 20px;
        }
        
        .store-info h1 {
            font-size: 24px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Background Animation -->
<div class="bg-animation">
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h4>Processing Payment...</h4>
        <p>Please wait while we complete your transaction</p>
    </div>
</div>

<div class="pos-wrapper">
    <!-- Creative Header -->
    <div class="pos-header">
        <div class="header-content">
            <div class="store-brand">
                <div class="store-avatar">
                    <i class="fas fa-store"></i>
                </div>
                <div class="store-info">
                    <h1>{{ store.name }} POS</h1>
                    <div class="store-meta">
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>{{ current_user.full_name }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-cash-register"></i>
                            <span>{{ cash_register.opening_balance|format_currency }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span id="currentTime"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-close-register" onclick="closeRegister()">
                <i class="fas fa-power-off me-2"></i>Close Register
            </button>
        </div>
    </div>

    <!-- Creative Main Layout -->
    <div class="pos-main">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="Search products, scan barcode, or enter SKU..." 
                       onkeyup="debounce(searchProducts, 300)()">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>

        <!-- Products Section -->
        <div class="products-section">
            <div id="productsGrid" class="products-grid">
                <!-- Products will be loaded dynamically -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyProducts" class="empty-cart" style="display: none;">
                <i class="fas fa-search"></i>
                <h5>No Products Found</h5>
                <p>Try different search terms or check your inventory</p>
            </div>
        </div>

        <!-- Cart Header -->
        <div class="cart-header">
            <div class="cart-title">
                <h3>
                    <i class="fas fa-shopping-cart"></i>
                    Shopping Cart
                    <span class="cart-count" id="cartCount">0</span>
                </h3>
                <button class="btn btn-outline-light btn-sm" onclick="clearCart()" title="Clear Cart">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <!-- Cart Content -->
        <div class="cart-content">
            <!-- Customer Selection -->
            <div class="customer-section">
                <label class="form-label">
                    <i class="fas fa-user me-2"></i>Customer
                </label>
                <select id="customerSelect" class="form-select">
                    <option value="">Walk-in Customer</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Cart Items -->
            <div class="cart-items" id="cartItems">
                <div class="empty-cart" id="emptyCart">
                    <i class="fas fa-shopping-cart"></i>
                    <h5>Cart is Empty</h5>
                    <p>Start adding products to see them here</p>
                </div>
            </div>
        </div>

        <!-- Cart Summary -->
        <div class="cart-summary" id="cartSummary" style="display: none;">
            <div class="summary-line">
                <span><i class="fas fa-receipt me-2"></i>Subtotal:</span>
                <span id="subtotalAmount">{{ get_currency_symbol() }}0.00</span>
            </div>
            <div class="summary-line">
                <span><i class="fas fa-percent me-2"></i>Tax:</span>
                <span id="taxAmount">{{ get_currency_symbol() }}0.00</span>
            </div>
            <div class="summary-line">
                <span><i class="fas fa-tag me-2"></i>Discount:</span>
                <span id="discountAmount">{{ get_currency_symbol() }}0.00</span>
            </div>
            
            <div class="summary-total">
                <span><i class="fas fa-dollar-sign me-2"></i>TOTAL:</span>
                <span id="totalAmount">{{ get_currency_symbol() }}0.00</span>
            </div>

            <!-- Payment Section -->
            <div class="payment-section">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-credit-card me-2"></i>Payment Method
                    </label>
                    <select id="paymentMethod" class="form-select" onchange="toggleCashPaymentDetails()">
                        <option value="Cash">💵 Cash</option>
                        <option value="Card">💳 Card</option>
                        <option value="Digital">📱 Digital Wallet</option>
                    </select>
                </div>

                <!-- Cash Payment Details -->
                <div id="cashPaymentDetails" class="cash-details">
                    <div class="form-group mb-0">
                        <label class="form-label">Amount Tendered</label>
                        <input type="number" id="amountTendered" class="form-control" 
                               step="0.01" min="0" placeholder="Enter amount received" 
                               onkeyup="calculateChange()">
                        <div class="change-amount">
                            Change: <span id="changeAmount">{{ get_currency_symbol() }}0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Checkout Button -->
                <button class="btn-checkout" onclick="processPayment()" id="checkoutBtn">
                    <i class="fas fa-bolt"></i>
                    Complete Sale
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
            <div class="modal-header border-0">
                <h4 class="modal-title">
                    <i class="fas fa-check-circle me-3"></i>Payment Successful!
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div id="receiptContent" style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; max-width: 400px; margin: 0 auto; background: white; color: black; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                    <!-- Receipt content will be dynamically inserted here -->
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light btn-lg" onclick="printReceipt()">
                    <i class="fas fa-print me-2"></i>Print Receipt
                </button>
                <button type="button" class="btn btn-outline-light btn-lg" onclick="emailReceipt()">
                    <i class="fas fa-envelope me-2"></i>Email Receipt
                </button>
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let cart = [];
let products = [];
let currentCustomer = null;
const CURRENCY = '{{ get_currency_symbol() }}';

// Update current time with animation
function updateTime() {
    const now = new Date();
    const timeElement = document.getElementById('currentTime');
    const newTime = now.toLocaleTimeString();
    
    if (timeElement.textContent !== newTime) {
        timeElement.style.opacity = '0.5';
        setTimeout(() => {
            timeElement.textContent = newTime;
            timeElement.style.opacity = '1';
        }, 150);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    updateTime();
    setInterval(updateTime, 1000);
    
    // Initialize payment method visibility
    toggleCashPaymentDetails();
    
    // Bind events
    document.getElementById('customerSelect').addEventListener('change', function(e) {
        currentCustomer = e.target.value || null;
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // F1 for search focus
        if (e.key === 'F1') {
            e.preventDefault();
            document.getElementById('productSearch').focus();
        }
        // Escape to clear search
        if (e.key === 'Escape') {
            document.getElementById('productSearch').value = '';
            searchProducts();
        }
    });
});

// Load products from API with enhanced display
function loadProducts() {
    showLoading(true);
    
    fetch('/pos/api/products')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showMessage(data.error, 'error');
                return;
            }
            products = data;
            displayProducts(products);
        })
        .catch(error => {
            console.error('Load products error:', error);
            showMessage('Failed to load products', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

function displayProducts(productsToShow) {
    const productsGrid = document.getElementById('productsGrid');
    const emptyProducts = document.getElementById('emptyProducts');
    
    if (!productsToShow || productsToShow.length === 0) {
        productsGrid.style.display = 'none';
        emptyProducts.style.display = 'block';
        return;
    }
    
    productsGrid.style.display = 'grid';
    emptyProducts.style.display = 'none';
    
    productsGrid.innerHTML = productsToShow.map(product => `
        <div class="product-card" onclick="addToCart(${product.id})" data-product-id="${product.id}">
            <div class="product-header">
                <h6 class="product-name">${product.name}</h6>
                <span class="product-sku">${product.sku || 'N/A'}</span>
            </div>
            
            <div class="product-price">${formatCurrency(product.price)}</div>
            
            <div class="product-stock">
                <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                    <i class="fas fa-cube"></i>
                    ${product.stock} left
                </span>
                ${product.tax_rate > 0 ? `<small style="color: rgba(255,255,255,0.7);">Tax: +${product.tax_rate}%</small>` : ''}
            </div>
            
            <button class="btn-add" ${product.stock <= 0 ? 'disabled' : ''}>
                <i class="fas fa-${product.stock <= 0 ? 'ban' : 'plus'}"></i>
                ${product.stock <= 0 ? 'Out of Stock' : 'Add to Cart'}
            </button>
        </div>
    `).join('');
}

function getStockBadgeClass(stock) {
    if (stock > 10) return 'stock-high';
    if (stock > 0) return 'stock-medium';
    return 'stock-low';
}

function searchProducts() {
    const searchTerm = document.getElementById('productSearch').value.trim();
    
    if (searchTerm.length < 2) {
        displayProducts(products);
        return;
    }
    
    fetch(`/pos/api/products/search?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showMessage(data.error, 'error');
                return;
            }
            displayProducts(data);
        })
        .catch(error => {
            console.error('Search error:', error);
            showMessage('Search failed', 'error');
        });
}

function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        showMessage('Product not found', 'error');
        return;
    }
    
    if (product.stock <= 0) {
        showMessage('Product out of stock', 'warning');
        return;
    }
    
    // Add visual feedback
    const productCard = document.querySelector(`[data-product-id="${productId}"]`);
    productCard.style.transform = 'scale(0.95)';
    setTimeout(() => {
        productCard.style.transform = '';
    }, 150);
    
    // Check if product already in cart
    const existingItem = cart.find(item => item.id === productId);
    
    if (existingItem) {
        if (existingItem.quantity >= product.stock) {
            showMessage('Cannot add more - insufficient stock', 'warning');
            return;
        }
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            stock: product.stock,
            tax_rate: product.tax_rate
        });
    }
    
    updateCartDisplay();
    showMessage(`${product.name} added to cart`, 'success');
}

function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const cartSummary = document.getElementById('cartSummary');
    const cartCount = document.getElementById('cartCount');
    
    // Update cart count
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
    cartCount.style.transform = 'scale(1.2)';
    setTimeout(() => { cartCount.style.transform = 'scale(1)'; }, 200);
    
    if (cart.length === 0) {
        emptyCart.style.display = 'block';
        cartSummary.style.display = 'none';
        return;
    }
    
    emptyCart.style.display = 'none';
    cartSummary.style.display = 'block';
    
    cartItems.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <div class="cart-item-header">
                <div class="cart-item-name">${item.name}</div>
                <button class="cart-item-remove" onclick="removeFromCart(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="cart-item-controls">
                <div class="quantity-controls">
                    <button class="btn-qty" onclick="decreaseQuantity(${index})">-</button>
                    <input type="number" class="quantity-input" value="${item.quantity}" 
                           min="1" max="${item.stock}" onchange="updateQuantity(${index}, this.value)">
                    <button class="btn-qty" onclick="increaseQuantity(${index})">+</button>
                </div>
                <div class="cart-item-price">
                    <div>${formatCurrency(item.price)} each</div>
                    <div class="cart-item-total">${formatCurrency(item.price * item.quantity)}</div>
                </div>
            </div>
        </div>
    `).join('');
    
    updateTotals();
}

function removeFromCart(index) {
    const item = cart[index];
    cart.splice(index, 1);
    updateCartDisplay();
    showMessage(`${item.name} removed from cart`, 'info');
}

function increaseQuantity(index) {
    const item = cart[index];
    if (item.quantity < item.stock) {
        item.quantity += 1;
        updateCartDisplay();
    } else {
        showMessage('Cannot add more - insufficient stock', 'warning');
    }
}

function decreaseQuantity(index) {
    const item = cart[index];
    if (item.quantity > 1) {
        item.quantity -= 1;
        updateCartDisplay();
    }
}

function updateQuantity(index, newQuantity) {
    const item = cart[index];
    const quantity = parseInt(newQuantity);
    
    if (quantity > 0 && quantity <= item.stock) {
        item.quantity = quantity;
        updateCartDisplay();
    } else {
        updateCartDisplay();
        showMessage('Invalid quantity', 'warning');
    }
}

function clearCart() {
    if (cart.length > 0 && confirm('Clear all items from cart?')) {
        cart = [];
        updateCartDisplay();
        showMessage('Cart cleared', 'info');
    }
}

function updateTotals() {
    let subtotal = 0;
    let tax = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        tax += itemTotal * (item.tax_rate / 100);
    });
    
    const discount = 0;
    const total = subtotal + tax - discount;
    
    // Animate number changes
    animateValue('subtotalAmount', subtotal);
    animateValue('taxAmount', tax);
    animateValue('discountAmount', discount);
    animateValue('totalAmount', total);
    
    calculateChange();
}

function animateValue(elementId, value) {
    const element = document.getElementById(elementId);
    element.style.transform = 'scale(1.1)';
    element.textContent = formatCurrency(value);
    setTimeout(() => {
        element.style.transform = 'scale(1)';
    }, 200);
}

function toggleCashPaymentDetails() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const cashDetails = document.getElementById('cashPaymentDetails');
    
    if (paymentMethod === 'Cash') {
        cashDetails.style.display = 'block';
        calculateChange();
    } else {
        cashDetails.style.display = 'none';
    }
}

function calculateChange() {
    const total = parseFloat(document.getElementById('totalAmount').textContent.replace(CURRENCY, '').replace(/,/g, '')) || 0;
    const amountTendered = parseFloat(document.getElementById('amountTendered').value) || 0;
    const change = Math.max(0, amountTendered - total);
    
    document.getElementById('changeAmount').textContent = formatCurrency(change);
}

function processPayment() {
    if (cart.length === 0) {
        showMessage('Cart is empty', 'warning');
        return;
    }
    
    const paymentMethod = document.getElementById('paymentMethod').value;
    const total = parseFloat(document.getElementById('totalAmount').textContent.replace(CURRENCY, '').replace(/,/g, '')) || 0;
    
    // Validate cash payment
    if (paymentMethod === 'Cash') {
        const amountTendered = parseFloat(document.getElementById('amountTendered').value) || 0;
        if (amountTendered < total) {
            showMessage('Amount tendered is insufficient', 'error');
            return;
        }
    }
    
    const saleData = {
        items: cart.map(item => ({
            product_id: item.id,
            quantity: item.quantity,
            unit_price: item.price
        })),
        customer_id: currentCustomer,
        payment_method: paymentMethod,
        amount_tendered: paymentMethod === 'Cash' ? parseFloat(document.getElementById('amountTendered').value) : total,
        discount: 0,
        notes: ''
    };
    
    showLoading(true);
    
    fetch('/pos/api/sale/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.success) {
            showSuccessModal(data);
            cart = [];
            currentCustomer = null;
            document.getElementById('customerSelect').value = '';
            document.getElementById('amountTendered').value = '';
            updateCartDisplay();
            loadProducts(); // Refresh product stock
        } else {
            showMessage(data.error || 'Payment failed', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Payment error:', error);
        showMessage('Payment processing failed', 'error');
    });
}

function showSuccessModal(saleData) {
    // Generate detailed receipt content
    const receiptContent = document.getElementById('receiptContent');
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US');
    const timeStr = now.toLocaleTimeString('en-US');
    
    // Get current user info and store info
    const storeName = '{{ store.name }}';
    const cashierName = '{{ current_user.full_name }}';
    const customerName = currentCustomer ? 
        (document.getElementById('customerSelect').selectedOptions[0]?.text || 'Walk-in Customer') : 
        'Walk-in Customer';
    
    let receiptHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-weight: bold; font-size: 16px;">CLOUD POS SYSTEM</div>
            <div style="font-size: 14px;">${storeName}</div>
            <div style="font-size: 12px; margin-top: 5px;">Receipt #: ${saleData.receipt_number}</div>
            <div style="font-size: 12px;">${dateStr} ${timeStr}</div>
        </div>
        
        <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0;">
            <div>Cashier: ${cashierName}</div>
            <div>Customer: ${customerName}</div>
        </div>
        
        <div style="margin: 15px 0;">
            <div style="font-weight: bold; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 8px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 50%; text-align: left;">ITEM</td>
                        <td style="width: 15%; text-align: center;">QTY</td>
                        <td style="width: 20%; text-align: right;">PRICE</td>
                        <td style="width: 15%; text-align: right;">TOTAL</td>
                    </tr>
                </table>
            </div>
    `;
    
    // Add cart items to receipt
    let subtotal = 0;
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        const itemName = item.name.length > 20 ? item.name.substring(0, 20) + '...' : item.name;
        receiptHTML += `
            <div style="margin: 6px 0; font-size: 13px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 50%; text-align: left; padding-right: 8px;">${itemName}</td>
                        <td style="width: 15%; text-align: center;">${item.quantity}</td>
                        <td style="width: 20%; text-align: right;">${formatCurrency(item.price)}</td>
                        <td style="width: 15%; text-align: right;">${formatCurrency(itemTotal)}</td>
                    </tr>
                </table>
            </div>
        `;
    });
    
    // Add totals section
    const paymentMethod = document.getElementById('paymentMethod').value;
    const amountTendered = paymentMethod === 'Cash' ? parseFloat(document.getElementById('amountTendered').value || saleData.total_amount) : saleData.total_amount;
    const changeAmount = Math.max(0, amountTendered - saleData.total_amount);
    
    receiptHTML += `
        </div>
        
        <div style="border-top: 1px dashed #000; padding-top: 10px; margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="text-align: left; padding: 3px 0;">Subtotal:</td>
                    <td style="text-align: right; padding: 3px 0;">${formatCurrency(subtotal)}</td>
                </tr>
                <tr>
                    <td style="text-align: left; padding: 3px 0;">Tax:</td>
                    <td style="text-align: right; padding: 3px 0;">${formatCurrency(0)}</td>
                </tr>
                <tr style="border-top: 1px solid #000;">
                    <td style="text-align: left; padding: 8px 0 3px 0; font-weight: bold; font-size: 16px;">TOTAL:</td>
                    <td style="text-align: right; padding: 8px 0 3px 0; font-weight: bold; font-size: 16px;">${formatCurrency(saleData.total_amount)}</td>
                </tr>
            </table>
            
            <div style="margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="text-align: left; padding: 3px 0;">Payment Method:</td>
                        <td style="text-align: right; padding: 3px 0;">${paymentMethod}</td>
                    </tr>
                    ${paymentMethod === 'Cash' ? `
                    <tr>
                        <td style="text-align: left; padding: 3px 0;">Amount Tendered:</td>
                        <td style="text-align: right; padding: 3px 0;">${formatCurrency(amountTendered)}</td>
                    </tr>
                    <tr>
                        <td style="text-align: left; padding: 3px 0; font-weight: bold;">Change:</td>
                        <td style="text-align: right; padding: 3px 0; font-weight: bold;">${formatCurrency(changeAmount)}</td>
                    </tr>
                    ` : ''}
                </table>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; font-size: 12px; border-top: 1px dashed #000; padding-top: 10px;">
            <div>Thank you for your business!</div>
            <div style="margin-top: 5px;">Visit us again soon</div>
            <div style="margin-top: 10px; font-size: 10px;">Powered by Cloud POS System</div>
        </div>
    `;
    
    receiptContent.innerHTML = receiptHTML;
    
    // Store receipt data for printing
    window.lastReceiptData = {
        receiptNumber: saleData.receipt_number,
        receiptHTML: receiptHTML,
        saleData: saleData
    };
    
    const modal = new bootstrap.Modal(document.getElementById('successModal'));
    modal.show();
}

function closeRegister() {
    if (confirm('Are you sure you want to close the register?')) {
        showLoading(true);
        
        fetch('/pos/register/close', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/pos/register/open';
                }, 2000);
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Close register error:', error);
            showMessage('Failed to close register', 'error');
        });
    }
}

function printReceipt() {
    if (!window.lastReceiptData) {
        showMessage('No receipt data available for printing', 'error');
        return;
    }
    
    const printWindow = window.open('', '_blank', 'width=400,height=600');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receipt ${window.lastReceiptData.receiptNumber}</title>
            <style>
                @media print {
                    body { margin: 0; padding: 0; }
                    .no-print { display: none; }
                }
                body {
                    font-family: 'Courier New', monospace;
                    font-size: 14px;
                    line-height: 1.4;
                    max-width: 400px;
                    margin: 20px auto;
                    background: white;
                    color: black;
                }
                .print-controls {
                    margin-bottom: 20px;
                    text-align: center;
                }
                .btn {
                    background: #6366f1;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    margin: 0 5px;
                    font-weight: 600;
                }
                .btn:hover {
                    background: #4f46e5;
                }
            </style>
        </head>
        <body>
            <div class="print-controls no-print">
                <button class="btn" onclick="window.print()">🖨️ Print Receipt</button>
                <button class="btn" onclick="window.close()">❌ Close</button>
            </div>
            ${window.lastReceiptData.receiptHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
    }, 250);
    
    showMessage('Receipt ready for printing', 'success');
}

function emailReceipt() {
    if (!window.lastReceiptData) {
        showMessage('No receipt data available', 'error');
        return;
    }
    
    const email = prompt('📧 Enter customer email address:');
    if (!email) return;
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showMessage('Please enter a valid email address', 'error');
        return;
    }
    
    showLoading(true);
    
    fetch('/pos/api/receipt/email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            receipt_number: window.lastReceiptData.receiptNumber,
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            showMessage(`Receipt sent to ${email}`, 'success');
        } else {
            showMessage(data.error || 'Failed to send receipt', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Email error:', error);
        showMessage('Failed to send receipt email', 'error');
    });
}

// Enhanced utility functions
function formatCurrency(amount) {
    return CURRENCY + parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.toggle('d-none', !show);
}

function showMessage(message, type) {
    // Create enhanced toast notification
    const toast = document.createElement('div');
    const icons = {
        success: '✅',
        error: '❌', 
        warning: '⚠️',
        info: 'ℹ️'
    };
    
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = `
        top: 20px; 
        right: 20px; 
        z-index: 10001; 
        min-width: 300px; 
        max-width: 400px;
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    `;
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">${icons[type] || 'ℹ️'}</span>
            <div>
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.parentNode.removeChild(toast);
            }, 150);
        }
    }, 5000);
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
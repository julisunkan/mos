{% extends "base.html" %}

{% block title %}POS System - {{ store.name }}{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
        --hover-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .pos-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .pos-header {
        background: var(--primary-gradient);
        border-radius: 20px;
        padding: 25px 30px;
        box-shadow: var(--card-shadow);
        margin-bottom: 25px;
        color: white;
    }
    
    .pos-header h1 {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .pos-main {
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        min-height: 85vh;
    }
    
    .products-section {
        padding: 30px;
        height: 85vh;
        overflow-y: auto;
    }
    
    .cart-section {
        padding: 30px;
        height: 85vh;
        overflow-y: auto;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-left: 3px solid #667eea;
    }
    
    .search-bar {
        margin-bottom: 30px;
        position: relative;
    }
    
    .search-input {
        border-radius: 50px;
        border: 3px solid #e2e8f0;
        padding: 18px 60px 18px 25px;
        font-size: 16px;
        width: 100%;
        background: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .search-input:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }
    
    .search-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 20px;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .product-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .product-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--hover-shadow);
        border-color: #667eea;
    }
    
    .product-card:hover::before {
        transform: scaleX(1);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .product-name {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        line-height: 1.3;
    }
    
    .product-sku {
        font-size: 12px;
        color: #6b7280;
        background: #f3f4f6;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .product-details {
        margin-bottom: 20px;
    }
    
    .product-price {
        font-size: 24px;
        font-weight: 800;
        color: #059669;
        margin-bottom: 8px;
    }
    
    .product-stock {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .stock-badge {
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .stock-high { background: #dcfce7; color: #166534; }
    .stock-medium { background: #fef3c7; color: #92400e; }
    .stock-low { background: #fee2e2; color: #991b1b; }
    
    .product-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .cart-header {
        background: var(--primary-gradient);
        color: white;
        padding: 20px 25px;
        margin: -30px -30px 25px -30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 20px 20px 0 0;
    }
    
    .cart-header h5 {
        font-weight: 700;
        font-size: 18px;
        margin: 0;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .cart-items {
        min-height: 300px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .cart-item {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        border: 2px solid #f1f5f9;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    
    .cart-item:hover {
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }
    
    .cart-summary {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        margin-top: 20px;
        border: 2px solid var(--primary-color);
    }
    
    .total-display {
        background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%);
        color: white;
        padding: 15px;
        border-radius: var(--border-radius);
        text-align: center;
        margin: 15px 0;
    }
    
    .btn-add {
        background: var(--success-gradient);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-add:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(16, 185, 129, 0.4);
        color: white;
    }
    
    .btn-add:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-checkout {
        background: var(--success-gradient);
        border: none;
        color: white;
        padding: 18px 30px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 18px;
        width: 100%;
        transition: all 0.3s;
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .btn-checkout:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        color: white;
    }
    
    .btn-close-register {
        background: var(--danger-color);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .btn-close-register:hover {
        background: #dc2626;
        color: white;
    }
    
    .empty-cart {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quantity-input {
        width: 60px;
        text-align: center;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 4px;
    }
    
    .btn-qty {
        background: var(--primary-color);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: var(--border-radius);
        text-align: center;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 992px) {
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px;
        }
        
        .product-card {
            padding: 15px;
        }
        
        .cart-section {
            border-left: none;
            border-top: 3px solid #667eea;
        }
    }
    
    @media (max-width: 768px) {
        .pos-container {
            padding: 15px;
        }
        
        .pos-header {
            padding: 20px;
            border-radius: 15px;
        }
        
        .pos-header h1 {
            font-size: 22px;
        }
        
        .products-section, .cart-section {
            height: auto;
            min-height: 60vh;
            padding: 20px;
        }
        
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .product-name {
            font-size: 16px;
        }
        
        .product-price {
            font-size: 20px;
        }
        
        .search-input {
            padding: 15px 50px 15px 20px;
        }
        
        .btn-checkout {
            font-size: 16px;
            padding: 15px 25px;
        }
    }
    
    @media (max-width: 576px) {
        .pos-header small {
            display: block;
            margin-top: 5px;
        }
        
        .products-grid {
            grid-template-columns: 1fr;
        }
        
        .product-card {
            padding: 12px;
        }
        
        .search-input {
            font-size: 16px; /* Prevents zoom on iOS */
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5>Processing...</h5>
    </div>
</div>

<div class="pos-container">
    <div class="container-fluid">
        <!-- POS Header -->
        <div class="pos-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="fas fa-store me-3"></i>
                        {{ store.name }} POS
                    </h1>
                    <small class="text-muted">
                        Store: {{ store.name }} | 
                        Cashier: {{ current_user.full_name }} |
                        Register: {{ cash_register.opening_balance|format_currency }}
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-close-register btn-sm" onclick="closeRegister()">
                        <i class="fas fa-times me-1"></i>Close Register
                    </button>
                </div>
            </div>
        </div>

        <!-- Main POS Interface -->
        <div class="pos-main">
            <div class="row g-0">
                <!-- Products Section -->
                <div class="col-lg-8">
                    <div class="products-section">
                        <!-- Product Search -->
                        <div class="search-bar">
                            <input type="text" id="productSearch" class="search-input" 
                                   placeholder="Search products by name, SKU, or barcode...">
                            <i class="fas fa-search search-icon"></i>
                        </div>

                        <!-- Products Grid -->
                        <div id="productsGrid" class="products-grid">
                            <!-- Products will be loaded dynamically -->
                        </div>
                        
                        <!-- Empty State -->
                        <div id="emptyProducts" class="empty-cart" style="display: none;">
                            <i class="fas fa-box-open fa-3x mb-3" style="color: #d1d5db;"></i>
                            <h5 style="color: #6b7280;">No Products Found</h5>
                            <p style="color: #9ca3af;">Try adjusting your search terms</p>
                        </div>
                    </div>
                </div>

                <!-- Cart Section -->
                <div class="col-lg-4">
                    <div class="cart-section">
                        <div class="cart-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Shopping Cart
                            </h5>
                            <button class="btn btn-outline-light btn-sm" onclick="clearCart()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <!-- Customer Selection -->
                        <div class="mb-3">
                            <label class="form-label">Customer</label>
                            <select id="customerSelect" class="form-select">
                                <option value="">Walk-in Customer</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Cart Items -->
                        <div class="cart-items" id="cartItems">
                            <div class="empty-cart" id="emptyCart">
                                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                <p>Your cart is empty<br><small>Search and add products to start</small></p>
                            </div>
                        </div>

                        <!-- Cart Summary -->
                        <div class="cart-summary" id="cartSummary" style="display: none;">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="subtotalAmount">{{ get_currency_symbol() }}0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tax:</span>
                                <span id="taxAmount">{{ get_currency_symbol() }}0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Discount:</span>
                                <span id="discountAmount">{{ get_currency_symbol() }}0.00</span>
                            </div>
                            
                            <div class="total-display">
                                <h4 class="mb-0">Total: <span id="totalAmount">{{ get_currency_symbol() }}0.00</span></h4>
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-3">
                                <label class="form-label">Payment Method</label>
                                <select id="paymentMethod" class="form-select">
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="Digital">Digital Wallet</option>
                                </select>
                            </div>

                            <!-- Cash Payment Details -->
                            <div id="cashPaymentDetails" class="mb-3">
                                <label class="form-label">Amount Tendered</label>
                                <input type="number" id="amountTendered" class="form-control" step="0.01" min="0">
                                <small class="text-muted">Change: <span id="changeAmount">{{ get_currency_symbol() }}0.00</span></small>
                            </div>

                            <!-- Checkout Button -->
                            <button class="btn-checkout" onclick="processPayment()" id="checkoutBtn">
                                <i class="fas fa-credit-card me-2"></i>Process Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal with Standard POS Receipt -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Sale Completed
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div id="receiptContent" style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; max-width: 400px; margin: 0 auto; background: white; color: black; padding: 20px; border: 1px solid #ddd;">
                    <!-- Receipt content will be dynamically inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="printReceipt()">
                    <i class="fas fa-print me-2"></i>Print Receipt
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="emailReceipt()">
                    <i class="fas fa-envelope me-2"></i>Email Receipt
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let cart = [];
let products = [];
let currentCustomer = null;
const CURRENCY = '{{ get_currency_symbol() }}';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializePOS();
});

function initializePOS() {
    loadProducts();
    setupEventListeners();
    updateCartDisplay();
}

function setupEventListeners() {
    // Search functionality
    const searchInput = document.getElementById('productSearch');
    searchInput.addEventListener('input', debounce(searchProducts, 300));
    
    // Customer selection
    const customerSelect = document.getElementById('customerSelect');
    customerSelect.addEventListener('change', function() {
        currentCustomer = this.value || null;
    });
    
    // Payment method change
    const paymentMethod = document.getElementById('paymentMethod');
    paymentMethod.addEventListener('change', toggleCashPaymentDetails);
    
    // Amount tendered input
    const amountTendered = document.getElementById('amountTendered');
    amountTendered.addEventListener('input', calculateChange);
}

function loadProducts() {
    showLoading(true);
    
    fetch('/pos/api/products')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showMessage(data.error, 'error');
                return;
            }
            
            products = data;
            displayProducts(products);
        })
        .catch(error => {
            console.error('Error loading products:', error);
            showMessage('Failed to load products', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

function displayProducts(productsToShow) {
    const productsGrid = document.getElementById('productsGrid');
    const emptyProducts = document.getElementById('emptyProducts');
    
    if (!productsToShow || productsToShow.length === 0) {
        productsGrid.style.display = 'none';
        emptyProducts.style.display = 'block';
        return;
    }
    
    productsGrid.style.display = 'grid';
    emptyProducts.style.display = 'none';
    
    productsGrid.innerHTML = productsToShow.map(product => `
        <div class="product-card">
            <div class="product-header">
                <div>
                    <h6 class="product-name">${product.name}</h6>
                </div>
                <span class="product-sku">${product.sku || 'N/A'}</span>
            </div>
            
            <div class="product-details">
                <div class="product-price">${formatCurrency(product.price)}</div>
                <div class="product-stock">
                    <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                        <i class="fas fa-boxes me-1"></i>
                        ${product.stock} in stock
                    </span>
                    ${product.tax_rate > 0 ? `<div><small class="text-muted">Tax: +${product.tax_rate}%</small></div>` : ''}
                </div>
            </div>
            
            <div class="product-footer">
                <button class="btn-add" 
                        onclick="addToCart(${product.id})"
                        ${product.stock <= 0 ? 'disabled' : ''}>
                    <i class="fas fa-${product.stock <= 0 ? 'times' : 'plus'}"></i>
                    ${product.stock <= 0 ? 'Out of Stock' : 'Add to Cart'}
                </button>
            </div>
        </div>
    `).join('');
}

function getStockBadgeClass(stock) {
    if (stock > 10) return 'stock-high';
    if (stock > 0) return 'stock-medium';
    return 'stock-low';
}

function searchProducts() {
    const searchTerm = document.getElementById('productSearch').value.trim();
    
    if (searchTerm.length < 2) {
        displayProducts(products);
        return;
    }
    
    fetch(`/pos/api/products/search?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showMessage(data.error, 'error');
                return;
            }
            displayProducts(data);
        })
        .catch(error => {
            console.error('Search error:', error);
            showMessage('Search failed', 'error');
        });
}

function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        showMessage('Product not found', 'error');
        return;
    }
    
    if (product.stock <= 0) {
        showMessage('Product out of stock', 'warning');
        return;
    }
    
    // Check if product already in cart
    const existingItem = cart.find(item => item.id === productId);
    
    if (existingItem) {
        if (existingItem.quantity >= product.stock) {
            showMessage('Cannot add more - insufficient stock', 'warning');
            return;
        }
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            stock: product.stock,
            tax_rate: product.tax_rate
        });
    }
    
    updateCartDisplay();
    showMessage(`${product.name} added to cart`, 'success');
}

function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const cartSummary = document.getElementById('cartSummary');
    
    if (cart.length === 0) {
        emptyCart.style.display = 'block';
        cartSummary.style.display = 'none';
        return;
    }
    
    emptyCart.style.display = 'none';
    cartSummary.style.display = 'block';
    
    cartItems.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <strong>${item.name}</strong>
                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <div class="quantity-controls">
                    <button class="btn-qty" onclick="decreaseQuantity(${index})">-</button>
                    <input type="number" class="quantity-input" value="${item.quantity}" 
                           min="1" max="${item.stock}" onchange="updateQuantity(${index}, this.value)">
                    <button class="btn-qty" onclick="increaseQuantity(${index})">+</button>
                </div>
                <div class="text-end">
                    <div>${formatCurrency(item.price)} each</div>
                    <strong>${formatCurrency(item.price * item.quantity)}</strong>
                </div>
            </div>
        </div>
    `).join('');
    
    updateCartTotals();
}

function updateCartTotals() {
    let subtotal = 0;
    let totalTax = 0;
    
    cart.forEach(item => {
        const lineTotal = item.price * item.quantity;
        subtotal += lineTotal;
        totalTax += lineTotal * (item.tax_rate / 100);
    });
    
    const discount = 0; // Could be implemented later
    const total = subtotal + totalTax - discount;
    
    document.getElementById('subtotalAmount').textContent = formatCurrency(subtotal);
    document.getElementById('taxAmount').textContent = formatCurrency(totalTax);
    document.getElementById('discountAmount').textContent = formatCurrency(discount);
    document.getElementById('totalAmount').textContent = formatCurrency(total);
    
    // Update amount tendered if cash payment
    if (document.getElementById('paymentMethod').value === 'Cash') {
        const amountTendered = parseFloat(document.getElementById('amountTendered').value) || 0;
        const change = Math.max(0, amountTendered - total);
        document.getElementById('changeAmount').textContent = formatCurrency(change);
    }
}

function removeFromCart(index) {
    const item = cart[index];
    cart.splice(index, 1);
    updateCartDisplay();
    showMessage(`${item.name} removed from cart`, 'info');
}

function increaseQuantity(index) {
    const item = cart[index];
    if (item.quantity < item.stock) {
        item.quantity += 1;
        updateCartDisplay();
    } else {
        showMessage('Cannot add more - insufficient stock', 'warning');
    }
}

function decreaseQuantity(index) {
    const item = cart[index];
    if (item.quantity > 1) {
        item.quantity -= 1;
        updateCartDisplay();
    }
}

function updateQuantity(index, newQuantity) {
    const item = cart[index];
    const quantity = parseInt(newQuantity);
    
    if (quantity > 0 && quantity <= item.stock) {
        item.quantity = quantity;
        updateCartDisplay();
    } else {
        // Reset to previous value
        updateCartDisplay();
        showMessage('Invalid quantity', 'warning');
    }
}

function clearCart() {
    if (cart.length > 0 && confirm('Clear all items from cart?')) {
        cart = [];
        updateCartDisplay();
        showMessage('Cart cleared', 'info');
    }
}

function toggleCashPaymentDetails() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const cashDetails = document.getElementById('cashPaymentDetails');
    
    if (paymentMethod === 'Cash') {
        cashDetails.style.display = 'block';
        calculateChange();
    } else {
        cashDetails.style.display = 'none';
    }
}

function calculateChange() {
    const total = parseFloat(document.getElementById('totalAmount').textContent.replace(CURRENCY, ''));
    const amountTendered = parseFloat(document.getElementById('amountTendered').value) || 0;
    const change = Math.max(0, amountTendered - total);
    
    document.getElementById('changeAmount').textContent = formatCurrency(change);
}

function processPayment() {
    if (cart.length === 0) {
        showMessage('Cart is empty', 'warning');
        return;
    }
    
    const paymentMethod = document.getElementById('paymentMethod').value;
    const total = parseFloat(document.getElementById('totalAmount').textContent.replace(CURRENCY, ''));
    
    // Validate cash payment
    if (paymentMethod === 'Cash') {
        const amountTendered = parseFloat(document.getElementById('amountTendered').value) || 0;
        if (amountTendered < total) {
            showMessage('Amount tendered is insufficient', 'error');
            return;
        }
    }
    
    const saleData = {
        items: cart.map(item => ({
            product_id: item.id,
            quantity: item.quantity,
            unit_price: item.price
        })),
        customer_id: currentCustomer,
        payment_method: paymentMethod,
        amount_tendered: paymentMethod === 'Cash' ? parseFloat(document.getElementById('amountTendered').value) : total,
        discount: 0,
        notes: ''
    };
    
    showLoading(true);
    
    fetch('/pos/api/sale/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.success) {
            showSuccessModal(data);
            clearCart();
            loadProducts(); // Refresh product stock
        } else {
            showMessage(data.error || 'Payment failed', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Payment error:', error);
        showMessage('Payment processing failed', 'error');
    });
}

function showSuccessModal(saleData) {
    // Generate detailed receipt content
    const receiptContent = document.getElementById('receiptContent');
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US');
    const timeStr = now.toLocaleTimeString('en-US');
    
    // Get current user info and store info
    const storeName = '{{ store.name }}';
    const cashierName = '{{ current_user.full_name }}';
    const customerName = currentCustomer ? 
        (document.getElementById('customerSelect').selectedOptions[0]?.text || 'Walk-in Customer') : 
        'Walk-in Customer';
    
    let receiptHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-weight: bold; font-size: 16px;">CLOUD POS SYSTEM</div>
            <div style="font-size: 14px;">${storeName}</div>
            <div style="font-size: 12px; margin-top: 5px;">Receipt #: ${saleData.receipt_number}</div>
            <div style="font-size: 12px;">${dateStr} ${timeStr}</div>
        </div>
        
        <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0;">
            <div>Cashier: ${cashierName}</div>
            <div>Customer: ${customerName}</div>
        </div>
        
        <div style="margin: 15px 0;">
            <div style="font-weight: bold; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 8px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 50%; text-align: left;">ITEM</td>
                        <td style="width: 15%; text-align: center;">QTY</td>
                        <td style="width: 20%; text-align: right;">PRICE</td>
                        <td style="width: 15%; text-align: right;">TOTAL</td>
                    </tr>
                </table>
            </div>
    `;
    
    // Add cart items to receipt
    let subtotal = 0;
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        const itemName = item.name.length > 20 ? item.name.substring(0, 20) + '...' : item.name;
        receiptHTML += `
            <div style="margin: 6px 0; font-size: 13px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 50%; text-align: left; padding-right: 8px;">${itemName}</td>
                        <td style="width: 15%; text-align: center;">${item.quantity}</td>
                        <td style="width: 20%; text-align: right;">${formatCurrency(item.price)}</td>
                        <td style="width: 15%; text-align: right;">${formatCurrency(itemTotal)}</td>
                    </tr>
                </table>
            </div>
        `;
    });
    
    // Add totals section
    const paymentMethod = document.getElementById('paymentMethod').value;
    const amountTendered = paymentMethod === 'Cash' ? parseFloat(document.getElementById('amountTendered').value || saleData.total_amount) : saleData.total_amount;
    const changeAmount = Math.max(0, amountTendered - saleData.total_amount);
    
    receiptHTML += `
        </div>
        
        <div style="border-top: 1px dashed #000; padding-top: 10px; margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="text-align: left; padding: 3px 0;">Subtotal:</td>
                    <td style="text-align: right; padding: 3px 0;">${formatCurrency(subtotal)}</td>
                </tr>
                <tr>
                    <td style="text-align: left; padding: 3px 0;">Tax:</td>
                    <td style="text-align: right; padding: 3px 0;">${formatCurrency(0)}</td>
                </tr>
                <tr style="border-top: 1px solid #000;">
                    <td style="text-align: left; padding: 8px 0 3px 0; font-weight: bold; font-size: 16px;">TOTAL:</td>
                    <td style="text-align: right; padding: 8px 0 3px 0; font-weight: bold; font-size: 16px;">${formatCurrency(saleData.total_amount)}</td>
                </tr>
            </table>
            
            <div style="margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="text-align: left; padding: 3px 0;">Payment Method:</td>
                        <td style="text-align: right; padding: 3px 0;">${paymentMethod}</td>
                    </tr>
                    ${paymentMethod === 'Cash' ? `
                    <tr>
                        <td style="text-align: left; padding: 3px 0;">Amount Tendered:</td>
                        <td style="text-align: right; padding: 3px 0;">${formatCurrency(amountTendered)}</td>
                    </tr>
                    <tr>
                        <td style="text-align: left; padding: 3px 0; font-weight: bold;">Change:</td>
                        <td style="text-align: right; padding: 3px 0; font-weight: bold;">${formatCurrency(changeAmount)}</td>
                    </tr>
                    ` : ''}
                </table>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; font-size: 12px; border-top: 1px dashed #000; padding-top: 10px;">
            <div>Thank you for your business!</div>
            <div style="margin-top: 5px;">Visit us again soon</div>
            <div style="margin-top: 10px; font-size: 10px;">Powered by Cloud POS System</div>
        </div>
    `;
    
    receiptContent.innerHTML = receiptHTML;
    
    // Store receipt data for printing
    window.lastReceiptData = {
        receiptNumber: saleData.receipt_number,
        receiptHTML: receiptHTML,
        saleData: saleData
    };
    
    const modal = new bootstrap.Modal(document.getElementById('successModal'));
    modal.show();
}

function closeRegister() {
    if (confirm('Are you sure you want to close the register?')) {
        showLoading(true);
        
        fetch('/pos/register/close', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/pos/register/open';
                }, 2000);
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Close register error:', error);
            showMessage('Failed to close register', 'error');
        });
    }
}

function printReceipt() {
    if (!window.lastReceiptData) {
        showMessage('No receipt data available for printing', 'error');
        return;
    }
    
    // Create a new window for printing with just the receipt
    const printWindow = window.open('', '_blank', 'width=400,height=600');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receipt ${window.lastReceiptData.receiptNumber}</title>
            <style>
                @media print {
                    body { margin: 0; padding: 0; }
                    .no-print { display: none; }
                }
                body {
                    font-family: 'Courier New', monospace;
                    font-size: 14px;
                    line-height: 1.4;
                    max-width: 400px;
                    margin: 20px auto;
                    background: white;
                    color: black;
                }
                .print-controls {
                    margin-bottom: 20px;
                    text-align: center;
                }
                .btn {
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 4px;
                    cursor: pointer;
                    margin: 0 5px;
                }
                .btn:hover {
                    background: #0056b3;
                }
            </style>
        </head>
        <body>
            <div class="print-controls no-print">
                <button class="btn" onclick="window.print()">Print Receipt</button>
                <button class="btn" onclick="window.close()">Close</button>
            </div>
            ${window.lastReceiptData.receiptHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    
    // Auto-focus and print
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
    }, 250);
    
    showMessage('Receipt ready for printing', 'success');
}

function emailReceipt() {
    if (!window.lastReceiptData) {
        showMessage('No receipt data available', 'error');
        return;
    }
    
    const email = prompt('Enter customer email address:');
    if (!email) return;
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showMessage('Please enter a valid email address', 'error');
        return;
    }
    
    showLoading(true);
    
    fetch('/pos/api/receipt/email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            receipt_number: window.lastReceiptData.receiptNumber,
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            showMessage(`Receipt sent to ${email}`, 'success');
        } else {
            showMessage(data.error || 'Failed to send receipt', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Email error:', error);
        showMessage('Failed to send receipt email', 'error');
    });
}

// Utility functions
function formatCurrency(amount) {
    return CURRENCY + parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.toggle('d-none', !show);
}

function showMessage(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize cash payment details visibility
toggleCashPaymentDetails();
</script>
{% endblock %}
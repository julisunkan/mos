{% extends "base.html" %}

{% block title %}Point of Sale - Cloud POS{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
    .pos-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .pos-header {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .pos-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: none;
        margin-bottom: 20px;
    }
    
    .product-grid {
        max-height: 70vh;
        overflow-y: auto;
        padding: 0;
    }
    
    #productsTable {
        margin-bottom: 0;
    }
    
    #productsTable thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white;
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
        padding: 15px 12px;
    }
    
    .product-row {
        transition: all 0.2s ease;
        border: none;
    }
    
    .product-row:hover {
        background-color: #f8f9fa !important;
        transform: scale(1.01);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .product-row td {
        padding: 15px 12px;
        vertical-align: middle;
        border-color: #e9ecef;
    }
    
    .table > :not(caption) > * > * {
        border-bottom-width: 1px;
    }
    
    .cart-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        display: flex;
        flex-direction: column;
    }
    
    .cart-items {
        flex: 1;
        overflow-y: auto;
        max-height: 400px;
    }
    
    .cart-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #007bff;
    }
    
    .cart-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-top: 15px;
    }
    
    .search-input {
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 12px 20px;
        font-size: 16px;
    }
    
    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-modern {
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
    }
    
    .btn-checkout {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        border: none;
        color: white;
    }
    
    .btn-checkout:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        color: white;
    }
    
    .store-badge {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .empty-cart {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .quantity-input {
        width: 60px;
        text-align: center;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .pos-container {
            padding: 10px;
        }
        
        .cart-container {
            position: static;
            max-height: none;
        }
        
        .pos-header {
            padding: 15px;
        }
        
        /* Mobile table adjustments */
        #productsTable thead th {
            padding: 10px 8px;
            font-size: 11px;
        }
        
        .product-row td {
            padding: 12px 8px;
        }
        
        /* Hide tax column on mobile */
        #productsTable th:nth-child(4),
        #productsTable td:nth-child(4) {
            display: none;
        }
    }
    
    @media (max-width: 576px) {
        /* Stack table horizontally on very small screens */
        .table-responsive {
            font-size: 14px;
        }
        
        #productsTable thead th {
            padding: 8px 6px;
            font-size: 10px;
        }
        
        .product-row td {
            padding: 10px 6px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* Hide stock column on very small screens */
        #productsTable th:nth-child(3),
        #productsTable td:nth-child(3) {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Message Area -->
<div id="messageArea" class="d-none">
    <div class="container-fluid">
        <div id="messageContent" class="alert alert-dismissible fade show" role="alert">
            <span id="messageText"></span>
            <button type="button" class="btn-close" onclick="hideMessage()"></button>
        </div>
    </div>
</div>

<div class="pos-container">
    <div class="container-fluid">
        <!-- POS Header -->
        <div class="pos-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0">
                        <i class="fas fa-cash-register text-primary me-2"></i>
                        Point of Sale
                    </h2>
                    <small class="text-muted">Store: {{ register.store.name }}</small>
                </div>
                <div class="col-md-6 text-end">
                    <span class="store-badge me-3">
                        <i class="fas fa-wallet me-1"></i>
                        Register: {{ register.opening_balance|format_currency }}
                    </span>
                    <button class="btn btn-warning btn-sm me-2" onclick="openReturns()">
                        <i class="fas fa-undo me-1"></i>Returns
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="closeRegister()">
                        <i class="fas fa-times me-1"></i>Close Register
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Products Section -->
            <div class="col-lg-8">
                <div class="pos-card">
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="mb-4">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="productSearch" class="search-input form-control border-start-0" 
                                       placeholder="Search products by name, SKU, or barcode...">
                            </div>
                        </div>

                        <!-- Products Table -->
                        <div id="productsContainer" class="product-grid">
                            <div class="table-responsive">
                                <table class="table table-hover" id="productsTable">
                                    <thead class="table-primary sticky-top">
                                        <tr>
                                            <th>Product Name</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Tax Rate</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsList">
                                        {% if products %}
                                            {% for product in products %}
                                            <tr class="product-row" 
                                                data-id="{{ product.id }}" 
                                                data-name="{{ product.name }}" 
                                                data-price="{{ product.selling_price }}"
                                                data-tax="{{ product.tax_rate or 0 }}"
                                                style="cursor: pointer;">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-cube text-primary me-2"></i>
                                                        <strong>{{ product.name }}</strong>
                                                    </div>
                                                    {% if product.sku %}
                                                    <small class="text-muted">SKU: {{ product.sku }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="fs-6 fw-bold text-success">{{ product.selling_price|format_currency }}</span>
                                                </td>
                                                <td>
                                                    {% set stock = product.get_store_stock(register.store_id) %}
                                                    <span class="badge {% if stock > 10 %}bg-success{% elif stock > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ stock }} left
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if product.tax_rate %}
                                                    <span class="badge bg-info">{{ product.tax_rate }}%</span>
                                                    {% else %}
                                                    <span class="text-muted">No tax</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <button class="btn btn-primary btn-sm" 
                                                            onclick="addProductToCart({{ product.id }}, '{{ product.name }}', {{ product.selling_price }}, {{ product.get_store_stock(register.store_id) }}, {{ product.tax_rate or 0 }})"
                                                            {% if product.get_store_stock(register.store_id) <= 0 %}disabled{% endif %}>
                                                        <i class="fas fa-plus me-1"></i>Add to Cart
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center py-5">
                                                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                                    <h5 class="text-muted">No products available in this store</h5>
                                                    <p class="text-muted">Contact your administrator to add products to this store.</p>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <div class="col-lg-4">
                <div class="cart-container">
                    <!-- Customer Selection -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-user me-2"></i>Customer
                        </label>
                        <select id="customerSelect" class="form-select">
                            <option value="">Walk-in Customer</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Cart Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>Cart
                        </h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">
                            <i class="fas fa-trash me-1"></i>Clear
                        </button>
                    </div>

                    <!-- Cart Items -->
                    <div class="cart-items" id="cartItems">
                        <div class="empty-cart" id="emptyCart">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <p>Your cart is empty<br>Add products to get started</p>
                        </div>
                    </div>

                    <!-- Cart Summary -->
                    <div class="cart-summary" id="cartSummary" style="display: none;">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax:</span>
                            <span id="tax">$0.00</span>
                        </div>
                        <hr class="bg-light">
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong id="total">$0.00</strong>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select id="paymentMethod" class="form-select">
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Digital">Digital Wallet</option>
                            </select>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-checkout btn-modern" onclick="processPayment()" id="checkoutBtn">
                                <i class="fas fa-credit-card me-2"></i>Process Payment
                            </button>
                            <button class="btn btn-secondary btn-modern" onclick="holdSale()">
                                <i class="fas fa-pause me-2"></i>Hold Sale
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Sale Completed
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-receipt fa-3x text-success mb-2"></i>
                    <h4>Payment Successful!</h4>
                    <p class="text-muted">Receipt #<span id="receiptNumber"></span></p>
                </div>
                <div class="receipt-details" id="receiptDetails">
                    <!-- Receipt details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="printReceipt()">
                    <i class="fas fa-print me-2"></i>Print Receipt
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="d-none" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status"></div>
            <h5>Processing...</h5>
        </div>
    </div>
</div>

<script>
// Global variables
let cart = [];
let currentCustomer = null;
const CURRENCY_SYMBOL = '{{ get_currency_symbol() }}' || '$';

// Initialize POS system
document.addEventListener('DOMContentLoaded', function() {
    initializePOS();
});

function initializePOS() {
    // Initialize search functionality
    const searchInput = document.getElementById('productSearch');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(searchProducts, 300));
    }
    
    // Initialize customer selection
    const customerSelect = document.getElementById('customerSelect');
    if (customerSelect) {
        customerSelect.addEventListener('change', function() {
            currentCustomer = this.value || null;
        });
    }
    
    updateCartDisplay();
}

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Search products
function searchProducts() {
    const query = document.getElementById('productSearch').value.trim();
    
    if (query.length < 2) {
        // Show default products
        showDefaultProducts();
        return;
    }
    
    fetch(`/pos/product/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(products => {
            displaySearchResults(products);
        })
        .catch(error => {
            console.error('Search error:', error);
            showMessage('Search error occurred', 'error');
        });
}

function showDefaultProducts() {
    document.getElementById('productsList').innerHTML = `
        {% for product in products %}
        <tr class="product-row" 
            data-id="{{ product.id }}" 
            data-name="{{ product.name }}" 
            data-price="{{ product.selling_price }}"
            data-tax="{{ product.tax_rate or 0 }}"
            style="cursor: pointer;">
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-cube text-primary me-2"></i>
                    <strong>{{ product.name }}</strong>
                </div>
                {% if product.sku %}
                <small class="text-muted">SKU: {{ product.sku }}</small>
                {% endif %}
            </td>
            <td>
                <span class="fs-6 fw-bold text-success">{{ product.selling_price|format_currency }}</span>
            </td>
            <td>
                {% set stock = product.get_store_stock(register.store_id) %}
                <span class="badge {% if stock > 10 %}bg-success{% elif stock > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                    {{ stock }} left
                </span>
            </td>
            <td>
                {% if product.tax_rate %}
                <span class="badge bg-info">{{ product.tax_rate }}%</span>
                {% else %}
                <span class="text-muted">No tax</span>
                {% endif %}
            </td>
            <td>
                <button class="btn btn-primary btn-sm" 
                        onclick="addProductToCart({{ product.id }}, '{{ product.name }}', {{ product.selling_price }}, {{ product.get_store_stock(register.store_id) }}, {{ product.tax_rate or 0 }})"
                        {% if product.get_store_stock(register.store_id) <= 0 %}disabled{% endif %}>
                    <i class="fas fa-plus me-1"></i>Add to Cart
                </button>
            </td>
        </tr>
        {% endfor %}
    `;
}

function displaySearchResults(products) {
    const container = document.getElementById('productsList');
    
    if (products.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No products found</h5>
                    <p class="text-muted">Try a different search term</p>
                </td>
            </tr>
        `;
        return;
    }
    
    container.innerHTML = products.map(product => `
        <tr class="product-row" style="cursor: pointer;">
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-cube text-primary me-2"></i>
                    <strong>${product.name}</strong>
                </div>
                ${product.sku ? `<small class="text-muted">SKU: ${product.sku}</small>` : ''}
            </td>
            <td>
                <span class="fs-6 fw-bold text-success">${formatCurrency(product.price)}</span>
            </td>
            <td>
                <span class="badge ${product.stock > 10 ? 'bg-success' : product.stock > 0 ? 'bg-warning' : 'bg-danger'}">
                    ${product.stock} left
                </span>
            </td>
            <td>
                ${product.tax_rate > 0 ? `<span class="badge bg-info">${product.tax_rate}%</span>` : '<span class="text-muted">No tax</span>'}
            </td>
            <td>
                <button class="btn btn-primary btn-sm" 
                        onclick="addProductToCart(${product.id}, '${product.name}', ${product.price}, ${product.stock}, ${product.tax_rate})"
                        ${product.stock <= 0 ? 'disabled' : ''}>
                    <i class="fas fa-plus me-1"></i>Add to Cart
                </button>
            </td>
        </tr>
    `).join('');
}

// Add product to cart
function addProductToCart(productId, name, price, stock, taxRate) {
    if (stock <= 0) {
        showMessage('Product out of stock', 'warning');
        return;
    }
    
    // Check if product already in cart
    const existingItem = cart.find(item => item.id === productId);
    
    if (existingItem) {
        if (existingItem.quantity >= stock) {
            showMessage('Cannot add more - insufficient stock', 'warning');
            return;
        }
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: productId,
            name: name,
            price: parseFloat(price),
            quantity: 1,
            stock: stock,
            taxRate: parseFloat(taxRate) || 0
        });
    }
    
    updateCartDisplay();
}

// Update cart display
function updateCartDisplay() {
    const cartItemsContainer = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const cartSummary = document.getElementById('cartSummary');
    
    if (cart.length === 0) {
        emptyCart.style.display = 'block';
        cartSummary.style.display = 'none';
        return;
    }
    
    emptyCart.style.display = 'none';
    cartSummary.style.display = 'block';
    
    cartItemsContainer.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${item.name}</h6>
                    <small class="text-muted">${formatCurrency(item.price)} each</small>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" onclick="decreaseQuantity(${index})">-</button>
                    <input type="number" class="quantity-input mx-2" value="${item.quantity}" 
                           min="1" max="${item.stock}" onchange="updateQuantity(${index}, this.value)">
                    <button class="btn btn-sm btn-outline-secondary" onclick="increaseQuantity(${index})">+</button>
                </div>
                <strong>${formatCurrency(item.price * item.quantity)}</strong>
            </div>
        </div>
    `).join('');
    
    updateCartTotals();
}

// Cart manipulation functions
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

function increaseQuantity(index) {
    if (cart[index].quantity < cart[index].stock) {
        cart[index].quantity++;
        updateCartDisplay();
    } else {
        showMessage('Cannot add more - insufficient stock', 'warning');
    }
}

function decreaseQuantity(index) {
    if (cart[index].quantity > 1) {
        cart[index].quantity--;
        updateCartDisplay();
    }
}

function updateQuantity(index, newQuantity) {
    const quantity = parseInt(newQuantity);
    if (quantity > 0 && quantity <= cart[index].stock) {
        cart[index].quantity = quantity;
        updateCartDisplay();
    }
}

function clearCart() {
    cart = [];
    updateCartDisplay();
}

// Update cart totals
function updateCartTotals() {
    let subtotal = 0;
    let totalTax = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        totalTax += itemTotal * (item.taxRate / 100);
    });
    
    const total = subtotal + totalTax;
    
    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('tax').textContent = formatCurrency(totalTax);
    document.getElementById('total').textContent = formatCurrency(total);
}

// Process payment
function processPayment() {
    if (cart.length === 0) {
        showMessage('Cart is empty', 'warning');
        return;
    }
    
    const paymentData = {
        items: cart.map(item => ({
            product_id: item.id,
            quantity: item.quantity,
            unit_price: item.price
        })),
        customer_id: currentCustomer,
        payment_method: document.getElementById('paymentMethod').value,
        discount: 0,
        notes: ''
    };
    
    showLoading(true);
    
    fetch('/pos/api/sale/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.success) {
            showReceiptModal(data);
            clearCart();
            showMessage('Sale completed successfully!', 'success');
        } else {
            showMessage(data.error || 'Payment failed', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Payment error:', error);
        showMessage('Payment processing failed', 'error');
    });
}

// Hold sale
function holdSale() {
    if (cart.length === 0) {
        showMessage('Cart is empty', 'warning');
        return;
    }
    
    // Implementation for holding sales
    showMessage('Hold sale feature coming soon', 'info');
}

// Utility functions
function formatCurrency(amount) {
    if (typeof amount === 'string') {
        amount = parseFloat(amount);
    }
    return CURRENCY_SYMBOL + amount.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.toggle('d-none', !show);
}

function showMessage(message, type) {
    const messageArea = document.getElementById('messageArea');
    const messageContent = document.getElementById('messageContent');
    const messageText = document.getElementById('messageText');
    
    messageText.textContent = message;
    messageContent.className = `alert alert-${type} alert-dismissible fade show`;
    messageArea.classList.remove('d-none');
    
    setTimeout(hideMessage, 5000);
}

function hideMessage() {
    document.getElementById('messageArea').classList.add('d-none');
}

function showReceiptModal(saleData) {
    document.getElementById('receiptNumber').textContent = saleData.receipt_number;
    
    const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
    modal.show();
}

function printReceipt() {
    window.print();
}

function closeRegister() {
    if (confirm('Are you sure you want to close the register?')) {
        showLoading(true);
        
        fetch('/pos/register/close', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                showMessage(data.message || 'Register closed successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/pos/register/open';
                }, 2000);
            } else {
                showMessage(data.error || 'Failed to close register', 'error');
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Close register error:', error);
            showMessage('Failed to close register', 'error');
        });
    }
}

function openReturns() {
    window.location.href = '/pos/returns';
}
</script>
{% endblock %}
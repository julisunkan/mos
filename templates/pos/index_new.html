{% extends "base.html" %}

{% block title %}Point of Sale - Cloud POS{% endblock %}

{% block content %}
<!-- Inline Message Area -->
<div id="messageArea" class="container-fluid d-none mt-2">
    <div id="messageContent" class="alert alert-dismissible fade show" role="alert">
        <span id="messageText"></span>
        <button type="button" class="btn-close" onclick="hideMessage()"></button>
    </div>
</div>

<div class="container-fluid mt-4">
    <!-- POS Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-cash-register me-2"></i>Point of Sale</h2>
                <div>
                    <a href="{{ url_for('pos.returns_interface') }}" class="btn btn-warning btn-sm me-2">
                        <i class="fas fa-undo me-1"></i>Returns
                    </a>
                    <span class="badge bg-success me-2">Register Open: {{ register.opening_balance|format_currency }}</span>
                    <button class="btn btn-danger btn-sm" onclick="closeRegister()">
                        <i class="fas fa-times me-1"></i>Close Register
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Product Search and Selection -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>Product Search
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search Bar -->
                    <div class="mb-3">
                        <input type="text" id="productSearch" class="form-control" 
                               placeholder="Search products by name, SKU, or barcode...">
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="row">
                        <!-- Search results will appear here -->
                    </div>

                    <!-- Default Products -->
                    <div class="row" id="defaultProducts">
                        {% for product in products %}
                        <div class="col-md-3 col-sm-4 col-6 mb-3">
                            <div class="card product-card h-100" 
                                 data-id="{{ product.id }}" 
                                 data-name="{{ product.name }}" 
                                 data-price="{{ product.selling_price }}"
                                 data-stock="{{ product.stock_quantity }}"
                                 data-tax="{{ product.tax_rate or 0 }}"
                                 onclick="addToCart(this)">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1">{{ product.name }}</h6>
                                    <p class="card-text mb-1">
                                        <strong>{{ format_currency(product.selling_price) }}</strong>
                                    </p>
                                    <small class="text-muted">Stock: {{ product.stock_quantity }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart and Checkout -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>Current Sale
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Customer Selection -->
                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        <select id="customerSelect" class="form-select">
                            <option value="">Walk-in Customer</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Cart Items -->
                    <div id="cartItems" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-4" id="emptyCart">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>No items in cart</p>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">{{ format_currency(0) }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax:</span>
                            <span id="taxAmount">{{ format_currency(0) }}</span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Discount:</label>
                            <div class="input-group">
                                <span class="input-group-text">{{ get_currency_symbol() }}</span>
                                <input type="number" id="discount" class="form-control" 
                                       value="0" min="0" step="0.01" onchange="updateTotals()">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong id="total">{{ format_currency(0) }}</strong>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select id="paymentMethod" class="form-select">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Mobile Money">Mobile Money</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="saleNotes" class="form-control" rows="2"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button id="processSale" class="btn btn-success btn-lg" onclick="processSale()" disabled>
                            <i class="fas fa-check me-2"></i>Process Sale
                        </button>
                        <button class="btn btn-warning" onclick="clearCart()">
                            <i class="fas fa-trash me-2"></i>Clear Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sale Success Modal -->
<div class="modal fade" id="saleSuccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sale Completed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 id="receiptNumber">Receipt: #12345</h5>
                <p id="saleTotal">Total: {{ format_currency(0) }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="printReceipt()">
                    <i class="fas fa-print me-2"></i>Print Receipt
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadReceipt()">
                    <i class="fas fa-download me-2"></i>Download PDF
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Close Register Form -->
<form id="closeRegisterForm" method="POST" action="{{ url_for('pos.close_register') }}" style="display: none;">
</form>
{% endblock %}

{% block scripts %}
<script>
// Get currency configuration from server
const defaultCurrency = '{{ get_default_currency() }}';
const currencySymbols = {
    'USD': '$',
    'EUR': '€',
    'GBP': '£',
    'NGN': '₦',
    'KES': 'KSh',
    'GHS': '₵'
};

// Format currency using default currency
function formatCurrency(amount) {
    const symbol = currencySymbols[defaultCurrency] || defaultCurrency + ' ';
    return symbol + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
}

// POS System Variables
let cart = [];
let lastReceiptNumber = null;

// Initialize POS
document.addEventListener('DOMContentLoaded', function() {
    updateCartDisplay();
    updateTotals();
    
    // Product search
    document.getElementById('productSearch').addEventListener('input', searchProducts);
});

// Search products
async function searchProducts() {
    const query = document.getElementById('productSearch').value.trim();
    const resultsContainer = document.getElementById('searchResults');
    const defaultProducts = document.getElementById('defaultProducts');
    
    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        defaultProducts.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch(`/pos/api/products/search?q=${encodeURIComponent(query)}`);
        const products = await response.json();
        
        defaultProducts.style.display = 'none';
        
        if (products.length === 0) {
            resultsContainer.innerHTML = '<div class="col-12"><p class="text-muted">No products found.</p></div>';
            return;
        }
        
        const html = products.map(product => `
            <div class="col-md-3 col-sm-4 col-6 mb-3">
                <div class="card product-card h-100" 
                     data-id="${product.id}" 
                     data-name="${product.name}" 
                     data-price="${product.price}"
                     data-stock="${product.stock}"
                     data-tax="${product.tax_rate}"
                     onclick="addToCart(this)">
                    <div class="card-body text-center p-2">
                        <h6 class="card-title mb-1">${product.name}</h6>
                        <p class="card-text mb-1">
                            <strong>${formatCurrency(product.price)}</strong>
                        </p>
                        <small class="text-muted">Stock: ${product.stock}</small>
                    </div>
                </div>
            </div>
        `).join('');
        
        resultsContainer.innerHTML = html;
    } catch (error) {
        console.error('Search error:', error);
        showAlert('Search failed', 'danger');
    }
}

// Add product to cart
function addToCart(productCard) {
    const productId = parseInt(productCard.dataset.id);
    const productName = productCard.dataset.name;
    const productPrice = parseFloat(productCard.dataset.price);
    const productStock = parseInt(productCard.dataset.stock);
    const productTax = parseFloat(productCard.dataset.tax || 0);
    
    console.log('Adding to cart:', { productId, productName, productPrice, productStock }); // Debug
    console.log('Product card dataset:', productCard.dataset); // Debug
    
    // Validate product ID
    if (!productId || isNaN(productId)) {
        showAlert('Invalid product selected!', 'danger');
        console.error('Invalid product ID:', productCard.dataset.id);
        return;
    }
    
    if (productStock <= 0) {
        showAlert('Product is out of stock!', 'warning');
        return;
    }
    
    // Check if product already in cart
    const existingItem = cart.find(item => item.id === productId);
    
    if (existingItem) {
        if (existingItem.quantity >= productStock) {
            showAlert('Cannot add more items than available in stock!', 'warning');
            return;
        }
        existingItem.quantity++;
    } else {
        cart.push({
            id: productId,
            name: productName,
            price: productPrice,
            quantity: 1,
            tax_rate: productTax,
            max_stock: productStock
        });
    }
    
    console.log('Cart after adding:', cart); // Debug
    updateCartDisplay();
    updateTotals();
    showAlert(`${productName} added to cart!`, 'success');
}

// Update cart display
function updateCartDisplay() {
    const cartContainer = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const processSaleBtn = document.getElementById('processSale');
    
    console.log('Updating cart display, cart length:', cart.length); // Debug
    
    if (cart.length === 0) {
        if (emptyCart) emptyCart.style.display = 'block';
        if (processSaleBtn) processSaleBtn.disabled = true;
        cartContainer.innerHTML = '';
        return;
    }
    
    if (emptyCart) emptyCart.style.display = 'none';
    if (processSaleBtn) processSaleBtn.disabled = false;
    
    const cartHtml = cart.map((item, index) => `
        <div class="cart-item border-bottom pb-2 mb-2">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${item.name}</h6>
                    <small class="text-muted">${formatCurrency(item.price)} each</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="input-group input-group-sm" style="width: 80px;">
                    <input type="number" class="form-control" 
                           value="${item.quantity}" min="1" max="${item.max_stock}"
                           onchange="updateQuantity(${index}, this.value)">
                </div>
                <strong>${formatCurrency(item.price * item.quantity)}</strong>
            </div>
        </div>
    `).join('');
    
    cartContainer.innerHTML = cartHtml;
}

// Update item quantity
function updateQuantity(index, newQuantity) {
    const quantity = parseInt(newQuantity);
    const item = cart[index];
    
    if (quantity <= 0) {
        removeFromCart(index);
        return;
    }
    
    if (quantity > item.max_stock) {
        showAlert('Cannot exceed available stock!', 'warning');
        updateCartDisplay(); // Reset display
        return;
    }
    
    item.quantity = quantity;
    updateCartDisplay();
    updateTotals();
}

// Remove item from cart
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
    updateTotals();
}

// Update totals
function updateTotals() {
    let subtotal = 0;
    let taxTotal = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        taxTotal += (itemTotal * item.tax_rate) / 100;
    });
    
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const total = subtotal + taxTotal - discount;
    
    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('taxAmount').textContent = formatCurrency(taxTotal);
    document.getElementById('total').textContent = formatCurrency(total);
}

// Clear cart
function clearCart() {
    cart = [];
    document.getElementById('customerSelect').value = '';
    document.getElementById('discount').value = '0';
    document.getElementById('saleNotes').value = '';
    document.getElementById('paymentMethod').value = 'Cash';
    updateCartDisplay();
    updateTotals();
}

// Process sale
async function processSale() {
    console.log('Processing sale, cart length:', cart.length); // Debug
    console.log('Cart contents:', cart); // Debug
    
    if (cart.length === 0) {
        showAlert('Cart is empty! Please add items before processing the sale.', 'warning');
        return;
    }
    
    const saleData = {
        items: cart.map(item => ({
            product_id: item.id,
            quantity: item.quantity,
            unit_price: item.price
        })),
        customer_id: document.getElementById('customerSelect').value || null,
        payment_method: document.getElementById('paymentMethod').value,
        discount: parseFloat(document.getElementById('discount').value) || 0,
        notes: document.getElementById('saleNotes').value
    };
    
    console.log('Sale data being sent:', JSON.stringify(saleData, null, 2)); // Debug
    
    try {
        const response = await fetch('/pos/api/sale/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(saleData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            lastReceiptNumber = result.receipt_number;
            document.getElementById('receiptNumber').textContent = `Receipt: ${result.receipt_number}`;
            document.getElementById('saleTotal').textContent = `Total: ${formatCurrency(result.total_amount)}`;
            
            const modal = new bootstrap.Modal(document.getElementById('saleSuccessModal'));
            modal.show();
            
            clearCart();
            showAlert('Sale processed successfully!', 'success');
        } else {
            showAlert(result.error || 'Sale processing failed!', 'danger');
        }
    } catch (error) {
        console.error('Sale processing error:', error);
        showAlert('Network error occurred!', 'danger');
    }
}

// Print receipt (opens in new window for printing)
function printReceipt() {
    if (!lastReceiptNumber) {
        showAlert('No receipt available!', 'warning');
        return;
    }
    
    const printWindow = window.open(`/pos/receipt/${lastReceiptNumber}/print`, '_blank', 'width=400,height=600');
    if (!printWindow) {
        showAlert('Please allow popups to print receipts', 'warning');
    }
}

// Download receipt PDF
function downloadReceipt() {
    if (!lastReceiptNumber) {
        showAlert('No receipt available!', 'warning');
        return;
    }
    
    const link = document.createElement('a');
    link.href = `/pos/receipt/${lastReceiptNumber}/download`;
    link.download = `receipt_${lastReceiptNumber}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Receipt PDF download started!', 'success');
}

// Close register
function closeRegister() {
    showConfirmation('Are you sure you want to close the cash register?', function() {
        document.getElementById('closeRegisterForm').submit();
    });
}

// Show confirmation dialog
function showConfirmation(message, onConfirm) {
    const messageArea = document.getElementById('messageArea');
    const messageContent = document.getElementById('messageContent');
    const messageText = document.getElementById('messageText');
    
    // Create confirmation content
    messageText.innerHTML = `
        ${message}
        <div class="mt-3">
            <button class="btn btn-danger btn-sm me-2" onclick="confirmAction()">Yes, Continue</button>
            <button class="btn btn-secondary btn-sm" onclick="hideMessage()">Cancel</button>
        </div>
    `;
    messageContent.className = 'alert alert-warning alert-dismissible fade show';
    
    // Store the confirmation action
    window.pendingConfirmAction = onConfirm;
    
    // Show message area
    messageArea.classList.remove('d-none');
}

// Execute confirmed action
function confirmAction() {
    if (window.pendingConfirmAction) {
        window.pendingConfirmAction();
        window.pendingConfirmAction = null;
    }
    hideMessage();
}

// Show inline message
function showAlert(message, type) {
    const messageArea = document.getElementById('messageArea');
    const messageContent = document.getElementById('messageContent');
    const messageText = document.getElementById('messageText');
    
    // Set message content and type
    messageText.textContent = message;
    messageContent.className = `alert alert-${type} alert-dismissible fade show`;
    
    // Show message area
    messageArea.classList.remove('d-none');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        hideMessage();
    }, 5000);
}

// Hide inline message
function hideMessage() {
    const messageArea = document.getElementById('messageArea');
    messageArea.classList.add('d-none');
}
</script>
{% endblock %}
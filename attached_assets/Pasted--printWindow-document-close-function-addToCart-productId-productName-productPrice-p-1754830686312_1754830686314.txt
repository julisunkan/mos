`); printWindow.document.close(); }); }); function addToCart(productId, productName, productPrice, productStock) { // Check if item already exists in cart const existingItem = cart.find(item => item.product_id === productId); if (existingItem) { if (existingItem.quantity < productStock) { existingItem.quantity++; } else { alert('Not enough stock available'); return; } } else { if (productStock > 0) { cart.push({ product_id: productId, name: productName, price: productPrice, quantity: 1, stock: productStock }); } else { alert('Product out of stock'); return; } } updateCartDisplay(); } function updateCartDisplay() { const cartItemsContainer = document.getElementById('cart-items'); const processSaleBtn = document.getElementById('process-sale-btn'); if (cart.length === 0) { cartItemsContainer.innerHTML = '
Cart is empty

'; processSaleBtn.disabled = true; } else { let html = ''; cart.forEach((item, index) => { html += `
${item.name}
${currencySymbol}${item.price.toFixed(2)} each
${item.quantity}
${currencySymbol}${(item.price * item.quantity).toFixed(2)}
`; }); cartItemsContainer.innerHTML = html; processSaleBtn.disabled = false; } updateCartTotals(); } function changeQuantity(index, change) { const item = cart[index]; const newQuantity = item.quantity + change; if (newQuantity <= 0) { removeFromCart(index); } else if (newQuantity <= item.stock) { item.quantity = newQuantity; updateCartDisplay(); } else { alert('Not enough stock available'); } } function removeFromCart(index) { cart.splice(index, 1); updateCartDisplay(); } function updateCartTotals() { let subtotal = 0; let tax = 0; cart.forEach(item => { const itemTotal = item.price * item.quantity; subtotal += itemTotal; // Assuming 10% tax rate for simplicity tax += itemTotal * 0.1; }); const total = subtotal + tax; document.getElementById('cart-subtotal').textContent = currencySymbol + subtotal.toFixed(2); document.getElementById('cart-tax').textContent = currencySymbol + tax.toFixed(2); document.getElementById('cart-total').textContent = currencySymbol + total.toFixed(2); } function processSale() { if (cart.length === 0) { alert('Cart is empty'); return; } const customerId = document.getElementById('customer-select').value; const paymentMethod = document.getElementById('payment-method').value; const saleData = { items: cart, customer_id: customerId || null, payment_method: paymentMethod }; // Show loading const processSaleBtn = document.getElementById('process-sale-btn'); const originalText = processSaleBtn.innerHTML; processSaleBtn.innerHTML = 'Processing...'; processSaleBtn.disabled = true; fetch('/cashier/api/process_sale', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify(saleData) }) .then(response => response.json()) .then(data => { if (data.success) { // Load receipt content fetch(`/cashier/receipt/${data.sale_id}`) .then(response => response.text()) .then(html => { const parser = new DOMParser(); const doc = parser.parseFromString(html, 'text/html'); const receiptContent = doc.querySelector('.receipt-content'); if (receiptContent) { document.getElementById('receipt-content').innerHTML = receiptContent.innerHTML; } // Show receipt modal document.getElementById('receipt-number').textContent = data.receipt_number; new bootstrap.Modal(document.getElementById('receiptModal')).show(); // Clear cart cart = []; updateCartDisplay(); }); } else { alert('Error: ' + data.error); } }) .catch(error => { console.error('Error:', error); alert('An error occurred while processing the sale'); }) .finally(() => { // Restore button processSaleBtn.innerHTML = originalText; processSaleBtn.disabled = false; }); }